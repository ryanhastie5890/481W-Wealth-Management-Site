<!DOCTYPE html>
<html lang="en" dir="ltr">
<!--webpage for retirement-->

<head>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <meta charset="utf-8">
  <title>COSC 481 Project</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="shortcut icon" href="#"> <!-- to remove 404 error favicon.ico not found -->
</head>

<body>
  <header>
    <header>
      <!--Header section of the website-->
      <div class="heading" style="height: 7vh;">
        <a href="index.html">Wealth Management System</a>
      </div>
      <!--Display user while logged in-->
      <div id="user-info" style="position:absolute; top:10px; right:20px; color:white;"></div>
    </header>


    <!-- menu-->
    <div class="menu">
      <a class="menu-option" href="RealEstate.html" style="color: lightgreen;"><i class="bi bi-house"></i>Real
        Estate</a>
      <a class="menu-option" href="Investment.html"><i class="bi bi-bank"></i>Investment</a>
      <a class="menu-option" href="Retirement.html"><i class="bi bi-sunglasses"></i>Retirement</a>
      <a class="menu-option" href="Accounts.html"><i class="bi bi-file-person"></i>Account</a>
      <a class="menu-option" href="admin.html" id="adminTab"><i class="bi bi-tools"></i>Admin</a>

    </div>

    <h2>Incomes - Expenses:</h2>
    <br>
    <h2 id="total"></h2>

    <div id="buttons">
      <!--add property button-->
      <!--<button class="addButton" style="display:flex">Add Property</button><br> -->
      <button type="button" class="btn btn-primary" onclick="showFormProp()">Add Property</button>
      <br>
      <br>
      <!--add income button-->
      <button type="button" class="btn btn-success" onclick="showFormInc()">Add income</button>
      <br>
      <br>
      <!--<button class="addButton" style="display:flex">Add Income</button><br> -->

      <!--add expense button-->
      <button type="button" class="btn btn-danger" onclick="showFormExp()">Add Expense</button>
      <!--<button class="addButton" onclick="showFormExp()" style="display:flex">Add Expense</button> -->
    </div>


    <!--Properties display-->
    <h2 id="propertyLabel">Your Properties: </h2>
    <div id="propertiesDisplay"></div>

    <!--Income display-->
    <h2 id="incomeLabel">Your Incomes: </h2>
    <div id="incomeDisplay"></div>

    <!--Expense display-->
    <h2 id="expenseLabel">Your Expenses: </h2>
    <div id="expenseDisplay">

    </div>

    <form action="/api/realEstate/add-property" method="POST">
      <div id="property_form" style="display:none;">
        <button type="button" class="btn-close" onclick="hideForms()" aria-label="Close"></button>

        <h3 class="heading">Add Property</h3>
        <div>

          <div class="row align-items-center mb-3">
          <div class="col-sm-4">
            <label for="propertyName" class="form-label">Name of Property</label>
          </div>
          <div class="col-sm-8">
            <input type="text" class="form-control" id="propertyName" placeholder="Enter name of Property" name="name" required>
          </div>
          </div>

          <div class ="row align-items-center mb-3">
            <div class="col-sm-4">
              <label for="propertyDescription" class="form-label mb-0">Description of Property</label>
              </div>
              <div class="col-sm-8">
              <input type="text" class="form-control" id="propertyDescription" placeholder="Enter description of Property" name="description" required>
          </div>
        </div>
    </form>

    <div class ="row align-items-center mb-3">
      <div class="col-sm-4">
        <label for="propertyType" class="form-label mb-0">Type of Property</label>
        </div>

        <div class="form-group col-sm-8">
          <select class = "propertyType" id="propertyTypeDropdown">
            <option>Apartment Complex</option>
            <option>House</option>
            <option>Parcel of land</option>
          </select>
        </div>
        <br>
    </div>
    <button type="submit" class="btn btn-primary">Add Property</button>
    <!--
      <button type="button" onclick="hideForms()" class="xButton">X</button>
      <form action="/api/realEstate/add-property" method="POST">
        <label for="name">Name of Property</label><br><br>
        <input name="name" type="text" required><br><br>

        <label for="description">Description of Property</label><br><br>
        <input name="description" type="text" required><br><br>

        <label for="type">Type of Property</label><br><br>
        <select name="type" required>
          <option value="Apartment">Apartment Complex</option>
          <option value="House">House</option>
          <option value="Land">Land</option>
        </select><br><br>

        <label for="status">Status of Property</label><br><br>
        <select name="status" required>
          <option value="Self Owned">Self Owned</option>
          <option value="Rented Out">Rented Out</option>
          <option value="Selling">Selling</option>
          <option value="Leasing">Leasing</option>
        </select><br><br>

        <label for="occupants">Number of Occupants</label><br><br>
        <input name="occupants" type="number" min="0" value="0"><br><br>

        <button type="submit">Add Property</button>
      </form>
    </div>
  -->

    <!--Income form-->
    <div id="income_form" style="display:none;">
      <form action="/api/realEstate/add-income" method="POST">
        <button type="button" onclick="hideForms()" class="xButton">X</button>
        <label for="amount">Amount</label><br><br>
        <input name="amount" type="number" step="0.01" min="0" placeholder="0.00" required><br><br>

        <label for="note">Note</label><br><br>
        <input name="note" type="text" required><br><br>

        <button type="submit">Add Income</button>
      </form>
    </div>

    <!--Expense form-->
    <div id="expense_form" style="display:none;">
      <form action="/api/realEstate/add-expense" method="POST">
        <button type="button" onclick="hideForms()" class="xButton">X</button>
        <label for="amount">Amount</label><br><br>
        <input name="amount" type="number" step="0.01" min="0" placeholder="0.00" required><br><br>

        <label for="note">Note</label><br><br>
        <input name="note" type="text" required><br><br>

        <button type="submit">Add Expense</button>
      </form>
    </div>

    <!--forms for updating items-->
    <div id="property_form_update" style="display:none;">
      <form id="editPropForm"><!--add property form-->

        <input type="hidden" id="propertyId" />
        <button type="button" onclick="hideForms()" class="xButton">X</button>

        <label for="name">Name of Property</label><br><br>
        <input id="pName" name="name" type="text" required><br><br>

        <label for="description">Description of Property</label><br><br>
        <input id="pDescription" name="description" type="text" required><br><br>

        <label for="type">Type of Property</label><br><br>
        <select id="pType" name="type" required>
          <option value="Apartment">Apartment Complex</option>
          <option value="House">House</option>
          <option value="Land">Land</option>
        </select><br><br>

        <label for="status">Status of Property</label><br><br>
        <select id="pStatus" name="status" required>
          <option value="Self Owned">Self Owned</option>
          <option value="Rented Out">Rented Out</option>
          <option value="Selling">Selling</option>
          <option value="Leasing">Leasing</option>
        </select><br><br>

        <label for="occupants">Number of Occupants</label><br><br>
        <input id="pOccupants" name="occupants" type="number" min="0" value="0"><br><br>

        <button type="submit">Update Property</button>
      </form>
    </div>

    <!--Income form-->
    <div id="income_form_update" style="display:none;">
      <form id="editIncForm">

        <input type="hidden" id="incomeId" />
        <button type="button" onclick="hideForms()" class="xButton">X</button>

        <label for="amount">Amount</label><br><br>
        <input id="iAmount" name="amount" type="number" step="0.01" min="0" placeholder="0.00" required><br><br>

        <label for="note">Note</label><br><br>
        <input id="iNote" name="note" type="text" required><br><br>

        <button type="submit">Update Income</button>
      </form>
    </div>

    <!--Expense form-->
    <div id="expense_form_update" style="display:none;">
      <form id="editExpForm">

        <input type="hidden" id="expenseId" />
        <button type="button" onclick="hideForms()" class="xButton">X</button>

        <label for="amount">Amount</label><br><br>
        <input id="eAmount" name="amount" type="number" step="0.01" min="0" placeholder="0.00" required><br><br>

        <label for="note">Note</label><br><br>
        <input id="eNote" name="note" type="text" required><br><br>

        <button type="submit">Update Expense</button>
      </form>
    </div>



    <!--Income, expenses, lease tracking, notifications.-->

    <script>
      fetch('/api/session/getSession')//get session
        .then(r => r.json())
        .then(data => {
          if (data.userId) {
            document.getElementById("message").innerHTML = "Logged in as: " + data.email;
          }
          else {
            document.getElementById("message").innerHTML = "You are not logged in";
          }
        })

      fetch('/api/realEstate/get-properties', { cache: "no-store" })
        .then(res => {
          if (!res.ok) throw new Error("You are not logged in");
          return res.json();
        })
        .then(property => {
          const display = document.getElementById("propertiesDisplay");

          if (property.length == 0) {
            display.innerHTML = "<p>You have not added any property";
            return;
          }
          property.forEach(p => {
            const div = document.createElement("div");
            div.className = "property-item";

            //populate with data
            div.innerHTML = `
                <h3>Name: ${p.name}</h3><br>
                <p>Description: ${p.description}</p><br>
                <p>Type: ${p.type}</p><br>
                <p>Status: ${p.status}</p><br>
                <p>Occupants: ${p.occupants}</p><br>
                <p>Created: ${new Date(p.created_at).toLocaleDateString()}</p><br>
                <button onclick= "updatePropertyForm(${p.id})">Edit Property</button><br>
                <button onclick= "deleteProperty(${p.id})">Remove Property</button>
                `;

            display.appendChild(div);
          });
        })
        .catch(err => {
          document.getElementById("propertiesDisplay").innerHTML = "<p>You are not logged in</p>"
        });

      fetch('/api/realEstate/get-incomes', { cache: "no-store" })
        .then(res => {
          if (!res.ok) throw new Error("You are not logged in");
          return res.json();
        })
        .then(income => {
          const display = document.getElementById("incomeDisplay");

          if (income.length == 0) {
            display.innerHTML = "<p>You have not added any income";
            return;
          }
          income.forEach(i => {
            const div = document.createElement("div");
            div.className = "income-item";

            //populate with data
            div.innerHTML = `
                <h3>Amount: ${i.amount}</h3><br>
                <p>Note: ${i.note}</p><br>
                <p>Created: ${new Date(i.created_at).toLocaleDateString()}</p><br>
                <button onclick= "updateIncomeForm(${i.id})">Update Income</button><br>
                <button onclick= "deleteIncome(${i.id})">Remove Income</button>
                `;

            display.appendChild(div);
          });
        })
        .catch(err => {
          document.getElementById("incomeDisplay").innerHTML = "<p>You are not logged in</p>"
        });

      fetch('/api/realEstate/get-expenses', { cache: "no-store" })
        .then(res => {
          if (!res.ok) throw new Error("You are not logged in");
          return res.json();
        })
        .then(expense => {
          const display = document.getElementById("expenseDisplay");

          if (expense.length == 0) {
            display.innerHTML = "<p>You have not added any expense";
            return;
          }
          expense.forEach(e => {
            const div = document.createElement("div");
            div.className = "expense-item";

            //populate with data
            div.innerHTML = `
                <h3>Amount: ${e.amount}</h3><br>
                <p>Note: ${e.note}</p><br>
                <p>Created: ${new Date(e.created_at).toLocaleDateString()}</p><br>
                <button onclick= "updateExpenseForm(${e.id})">Edit Expense</button><br>
                <button onclick= "deleteExpense(${e.id})">Remove Expense</button>
                `;

            display.appendChild(div);
          });
        })
        .catch(err => {
          document.getElementById("expenseDisplay").innerHTML = "<p>You are not logged in</p>"
        });

      //calculate finance total
      Promise.all([
        fetch('/api/realEstate/get-incomes').then(r => r.json()),
        fetch('/api/realEstate/get-expenses').then(r => r.json())
      ])
        .then(([incomes, expenses]) => {
          let total = incomes.reduce((sum, i) => sum + Number(i.amount), 0);
          total -= expenses.reduce((sum, e) => sum + Number(e.amount), 0);
          document.getElementById('total').innerHTML = total.toFixed(2);
        })

      //delete property call
      function deleteProperty(propId) {
        fetch(`/api/realEstate/delete-property/${propId}`, {
          method: 'DELETE'
        })
          .then(res => res.json())
          .then(data => {
            console.log(data);
            if (data.success) {
              location.reload();//reload page
            }
          })
          .catch(err => console.error(err));
      }

      //delete income call
      function deleteIncome(incId) {
        fetch(`/api/realEstate/delete-income/${incId}`, {
          method: 'DELETE'
        })
          .then(res => res.json())
          .then(data => {
            console.log(data);
            if (data.success) {
              location.reload();//reload page
            }
          })
          .catch(err => console.error(err));
      }

      //delete expense call
      function deleteExpense(expId) {
        fetch(`/api/realEstate/delete-expense/${expId}`, {
          method: 'DELETE'
        })
          .then(res => res.json())
          .then(data => {
            console.log(data);
            if (data.success) {
              location.reload();//reload page
            }
          })
          .catch(err => console.error(err));
      }

      //submit actions for update forms
      document.getElementById('editPropForm').addEventListener('submit', e => {
        e.preventDefault();

        const id = document.getElementById('propertyId').value;

        fetch(`/api/realEstate/update-property/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: document.getElementById('pName').value,
            description: document.getElementById('pDescription').value,
            type: document.getElementById("pType").value,
            status: document.getElementById("pStatus").value,
            occupants: document.getElementById("pOccupants").value
          })
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) location.reload();
          });
      })

      document.getElementById('editIncForm').addEventListener('submit', e => {
        e.preventDefault();

        const id = document.getElementById('incomeId').value;

        fetch(`/api/realEstate/update-income/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: document.getElementById("iAmount").value,
            note: document.getElementById("iNote").value
          })
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) location.reload();
          });
      })

      document.getElementById('editExpForm').addEventListener('submit', e => {
        e.preventDefault();

        const id = document.getElementById('expenseId').value;

        fetch(`/api/realEstate/update-expense/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: document.getElementById("eAmount").value,
            note: document.getElementById("eNote").value
          })
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) location.reload();
          });
      })

      //for toggling on the forms
      function showFormProp() {
        hideForms();
        hideButtons();
        document.getElementById("property_form").style.display = "flex";
        hideDisplays();
      }

      function showFormInc() {
        hideForms();
        hideButtons();
        document.getElementById("income_form").style.display = "flex";
        hideDisplays();
      }

      function showFormExp() {
        hideForms();
        hideButtons();
        document.getElementById("expense_form").style.display = "flex";
        hideDisplays();
      }

      function updatePropertyForm(id) {
        hideForms();
        hideButtons();
        document.getElementById("property_form_update").style.display = "flex";
        document.getElementById("propertyId").value = id;
        hideDisplays();
      }

      function updateIncomeForm(id) {
        hideForms();
        hideButtons();
        document.getElementById("income_form_update").style.display = "flex";
        document.getElementById("incomeId").value = id;
        hideDisplays();
      }

      function updateExpenseForm(id) {
        hideForms();
        hideButtons();
        document.getElementById("expense_form_update").style.display = "flex";
        document.getElementById("expenseId").value = id;
        hideDisplays();
      }

      //TO FIX: add class names to all forms and displays then use that

      function hideDisplays() {
        document.getElementById("propertiesDisplay").style.display = "none";
        document.getElementById("incomeDisplay").style.display = "none";
        document.getElementById("expenseDisplay").style.display = "none";
        document.getElementById("propertyLabel").style.display = "none";
        document.getElementById("incomeLabel").style.display = "none";
        document.getElementById("expenseLabel").style.display = "none";
      }

      function showDisplays() {
        document.getElementById("propertiesDisplay").style.display = "flex";
        document.getElementById("incomeDisplay").style.display = "flex";
        document.getElementById("expenseDisplay").style.display = "flex";
        document.getElementById("propertyLabel").style.display = "flex";
        document.getElementById("incomeLabel").style.display = "flex";
        document.getElementById("expenseLabel").style.display = "flex";

      }

      //hide forms
      function hideForms() {
        document.getElementById("property_form").style.display = "none";
        document.getElementById("income_form").style.display = "none";
        document.getElementById("expense_form").style.display = "none";
        document.getElementById("property_form_update").style.display = "none";
        document.getElementById("income_form_update").style.display = "none";
        document.getElementById("expense_form_update").style.display = "none";
        showButtons();
        showDisplays();
      }

      //hide buttons
      function hideButtons() {
        const buttons = document.getElementsByClassName("addButton");
        for (let b of buttons) {
          b.style.display = "none";
        }
      }

      //show buttons
      function showButtons() {
        const buttons = document.getElementsByClassName("addButton");
        for (let b of buttons) {
          b.style.display = "flex";
        }
      }


    </script>
</body>

</html>